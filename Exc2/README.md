# Мониторинг

## Мотивация

Введение мониторинга необходимо для оперативного выявления проблем и принятия мер до того, как они повлияют на бизнес. Это позволит улучшить надежность и производительность системы, минимизировать время простоя и, как следствие, повысить удовлетворенность клиентов. Мониторинг даст компании полную картину о работе системы, что особенно важно с учетом растущей нагрузки и интеграции с внешними партнерами.

## Выбор подхода к мониторингу

- API и сервисы (Shop API, CRM API, MES API): Используем подход RED (Rate, Errors, Duration) для отслеживания производительности и надежности.
- Системы хранения данных (Shop DB, MES DB): Применяем подход USE (Utilization, Saturation, Errors) для мониторинга использования ресурсов.
- Общая система (включая очереди сообщений и 3D-файловое хранилище): Используем Четыре золотых сигнала (Latency, Traffic, Errors, Saturation) для комплексного мониторинга.

## Выбор метрик и их обоснование

### API Метрики

1. Number of requests (RPS) для всех API
   - Зачем: Для понимания нагрузки и использования API различными клиентами.
   - Ярлыки: Тип запроса, пользователь.

2. Response time (latency) для всех API
   - Зачем: Для мониторинга времени отклика и выявления задержек.
   - Ярлыки: Эндпоинт, тип запроса.

3. Number of HTTP 500 для всех API
   - Зачем: Для выявления критических ошибок.
   - Ярлыки: Эндпоинт.

4. CPU % и Memory Utilisation для всех API
   - Зачем: Для отслеживания использования ресурсов и предотвращения перегрузки.
   - Ярлыки: Инстанс сервера.

5. Number of simultanious sessions для всех API
   - Зачем: Для оценки количества одновременных пользователей.
   - Ярлыки: Инстанс API.

### RabbitMQ Метрики

6. Number of dead-letter-exchange letters
   - Зачем: Для выявления сообщений, которые не могут быть обработаны.
   - Ярлыки: Тип сообщения.

7. Number of message in flight
   - Зачем: Для мониторинга сообщений, находящихся в обработке.
   - Ярлыки: Тип сообщения.

### База данных Метрики

8. Memory Utilisation и Number of connections для всех DB
   - Зачем: Для оценки использования памяти и количества подключений.
   - Ярлыки: Инстанс базы данных.

9. Size of db instance для всех DB
   - Зачем: Для мониторинга размера баз данных.
   - Ярлыки: Инстанс базы данных.

### S3 Хранилище

10. Size of S3 storage
    - Зачем: Для оценки использования объема хранилища.
    - Ярлыки: Тип данных (3D-модели).

### Трафик Метрики

11. Kb transferred (received/provided) для всех API
    - Зачем: Для отслеживания объема входящего и исходящего трафика.
    - Ярлыки: Эндпоинт.

### Обоснование выбора

Эти метрики обеспечивают всесторонний мониторинг производительности и надежности ключевых компонентов системы. Они помогут в:

- Быстром выявлении проблем с API и базами данных.
- Оценке нагрузки и эффективности использования ресурсов.
- Мониторинге взаимодействия с внешними партнерами через RabbitMQ и API.

## План действий

1. Создать инстанс time-series базы данных
   - Выбрать подходящую технологию (например, Prometheus, InfluxDB) для хранения и анализа метрик.

2. Настроить сбор метрик для API и серверов
   - Внедрить агенты мониторинга, такие как Prometheus Exporters, для сбора данных о запросах, ошибках, времени отклика, использовании CPU и памяти.

3. Настроить мониторинг RabbitMQ
   - Внедрить метрики dead-letter-exchange и message in flight, используя соответствующие плагины и инструменты.

4. Настроить мониторинг базы данных
   - Собрать метрики использования памяти, количества подключений и размера базы данных.

5. Настроить мониторинг S3 хранилища
   - Внедрить сбор данных о размере хранилища и его использовании.

6. Установить и настроить систему визуализации
   - Использовать Grafana или аналогичный инструмент для визуализации метрик и создания дашбордов.

7. Определить пороговые значения для насыщенности
   - Установить предупреждения и алерты для CPU, памяти, количества соединений и других ключевых показателей.

8. Настроить автоматические уведомления и алерты
   - Интегрировать с системами уведомлений (например, Slack, email) для мгновенного оповещения команды о превышении пороговых значений.

## Показатели насыщенности и действия при их превышении

- CPU Utilization > 80%
  - Действия: Уведомление команды, автоматическое масштабирование (добавление инстансов).

- Memory Utilization > 75%
  - Действия: Завести тикет для анализа, увеличить объем памяти инстансов.

- Number of connections > 90% от лимита
  - Действия: Написать письмо в саппорт, проанализировать необходимость оптимизации запросов.

- Message in flight в RabbitMQ > 1000
  - Действия: Завести тикет для анализа очереди, рассмотреть возможность увеличения мощности RabbitMQ.

- Size of S3 storage > 90%
  - Действия: Оптимизировать хранение данных, добавить емкость.